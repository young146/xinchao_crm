# 💰 미수금 계산 로직 설명

## ✅ 올바른 계산 방식

### 기본 공식
```
총 계약 금액 = 호당 단가 × 계약 호수
미수금 = 총 계약 금액 - 수금 완료
수금률 = (수금 완료 / 총 계약 금액) × 100%
```

---

## 📊 예시 1: 다회차 계약

### 입력 데이터
```
업체명: Awesome Academy
호당 단가: $450
시작 호수: 552
종료 호수: 557
계약 호수: 557 - 552 + 1 = 6개 호
```

### 계산
```
총 계약 금액 = $450 × 6 = $2,700
수금 완료 = $450 (1개 호만 수금)
미수금 = $2,700 - $450 = $2,250
수금률 = ($450 / $2,700) × 100 = 16.7%
```

### Google Sheets에 저장되는 값
```
┌─────┬─────────┬─────────┬──────────┬─────────┐
│ No. │ 업체명   │ 단가    │ 수금완료 │ 미수금  │
├─────┼─────────┼─────────┼──────────┼─────────┤
│  1  │ Awesome │  $450   │  $450    │ $2,250  │
│     │ Academy │(호당)   │(1개호)   │(5개호)  │
└─────┴─────────┴─────────┴──────────┴─────────┘
```

---

## 📊 예시 2: 단발 광고

### 입력 데이터
```
업체명: Test Company
호당 단가: $300
시작 호수: (없음)
종료 호수: (없음)
```

### 계산
```
총 계약 금액 = $300 (호수 정보 없으면 단가가 총액)
수금 완료 = $0
미수금 = $300 - $0 = $300
수금률 = ($0 / $300) × 100 = 0%
```

### Google Sheets에 저장되는 값
```
┌─────┬─────────┬─────────┬──────────┬─────────┐
│ No. │ 업체명   │ 단가    │ 수금완료 │ 미수금  │
├─────┼─────────┼─────────┼──────────┼─────────┤
│  2  │ Test    │  $300   │  $0      │ $300    │
│     │ Company │(총액)   │          │         │
└─────┴─────────┴─────────┴──────────┴─────────┘
```

---

## 📊 예시 3: 수금 완료

### 입력 데이터
```
업체명: Pet Like Park
호당 단가: $450
시작 호수: 549
종료 호수: 554
계약 호수: 554 - 549 + 1 = 6개 호
```

### 계산
```
총 계약 금액 = $450 × 6 = $2,700
수금 완료 = $2,700 (전액 수금)
미수금 = $2,700 - $2,700 = $0
수금률 = ($2,700 / $2,700) × 100 = 100%
```

### Google Sheets에 저장되는 값
```
┌─────┬──────────┬─────────┬──────────┬─────────┐
│ No. │ 업체명    │ 단가    │ 수금완료 │ 미수금  │
├─────┼──────────┼─────────┼──────────┼─────────┤
│  3  │ Pet Like │  $450   │ $2,700   │   $0    │
│     │ Park     │(호당)   │(전액)    │         │
└─────┴──────────┴─────────┴──────────┴─────────┘
```

---

## 🔍 Google Sheets 컬럼 구조

### ADVERTISEMENT DETAILS 시트
```
A    B           C      D     E       F      G       H          I           J
No.  CUSTOMER    Address Tel   PageNo  Size   Price   Received   HaveCollect Remarks
                                              (단가)  (수금완료) (미수금)
```

### 각 컬럼 의미
```
G (Price):      호당 단가 또는 총 계약 금액 (호수 없는 경우)
H (Received):   실제 수금된 금액
I (HaveCollect): 미수금 = 총 계약 금액 - Received
J (Remarks):    호수 정보 (예: "552~557")
```

---

## 💻 코드에서의 구현

### 1. CustomerCard.js (고객 카드 표시)
```javascript
// 데이터 읽기
const price = parsePrice(customer[6]);       // 호당 단가
const received = parsePrice(customer[7]);    // 수금 완료
const { startVol, endVol } = parseVolumeRange(customer[9]); // 호수

// 총 계약 금액 계산
const totalAmount = startVol && endVol 
  ? price * (endVol - startVol + 1)  // 다회차: 단가 × 호수
  : price;                           // 단발: 단가가 총액

// ✅ 미수금 계산 (원본 시트 값 무시)
const unpaid = totalAmount - received;

// 수금률 계산
const collectionRate = totalAmount > 0 
  ? ((received / totalAmount) * 100).toFixed(1) 
  : 0;
```

### 2. AddCustomerForm.js (새 고객 추가)
```javascript
// 총 계약 금액 계산
const price = parseFloat(formData.price);
let totalAmount = price;
if (formData.startVol && formData.endVol) {
  const issueCount = parseInt(formData.endVol) - parseInt(formData.startVol) + 1;
  totalAmount = price * issueCount;
}

// Google Sheets에 저장할 데이터
const newCustomerData = [
  formData.customerName,
  // ...
  `$${formData.price}`,    // G: 호당 단가
  "$0",                    // H: 초기 수금 = $0
  `$${totalAmount}`,       // I: 초기 미수금 = 총 계약 금액
  // ...
];
```

### 3. GoogleAppsScript_자동추가.gs
```javascript
// 총 계약 금액 계산
var totalAmount = data.price || 0;
if (data.startVol && data.endVol) {
  var issueCount = parseInt(data.endVol) - parseInt(data.startVol) + 1;
  var priceNum = parseFloat(data.price.replace(/[^0-9.]/g, ''));
  totalAmount = "$" + (priceNum * issueCount);
}

const newRow = [
  // ...
  data.price || "",      // G: 호당 단가
  data.received || "$0", // H: 초기 수금
  totalAmount,           // I: 초기 미수금 = 총 계약 금액
  // ...
];
```

---

## ⚠️ 중요 사항

### 1. 원본 시트의 "Have collect" 컬럼
```
❌ 이전: 원본 시트의 값을 그대로 읽음
✅ 현재: 앱에서 자동 계산 (totalAmount - received)

이유: 원본 시트 값이 수동 입력되어 있을 수 있음
     앱에서 항상 정확한 계산 보장
```

### 2. Price 컬럼의 의미
```
다회차 계약: 호당 단가
단발 광고:   총 계약 금액

예시:
- "552~557" 있음 → Price = $450 (호당)
- 호수 정보 없음 → Price = $450 (총액)
```

### 3. 수금률 색상 코드
```javascript
100% 이상  → 🟢 초록색 (수금 완료)
50~100%    → 🟠 주황색 (수금 진행 중)
50% 미만   → 🔴 빨간색 (미수금 많음)
```

---

## 📊 대시보드에서 확인하는 방법

### 1. 테이블에서
```
업체명 | 단가  | 수금완료 | 미수금
-------+-------+---------+--------
Awesome| $450  | $450    | $2,250  ← 빨간색 표시
```

### 2. 고객 카드에서
```
╔════════════════════════════════╗
║ 💰 수금 현황                   ║
║ ────────────────────────────  ║
║ 수금률: 16.7%                  ║
║ ████░░░░░░░░░░░░░░░░░░ 16.7%  ║ ← 빨간색 프로그레스
║                                ║
║ 총 계약: $2,700                ║
║ 수금: $450                     ║
║ 미수금: $2,250 ← 빨간색        ║
╚════════════════════════════════╝
```

---

## 🧮 계산 검증

### 검증 1: 다회차 계약
```
입력: 단가 $450, 호수 552~557 (6개)
계산: $450 × 6 = $2,700
결과: 총액 $2,700 ✅

수금: $450
미수금: $2,700 - $450 = $2,250 ✅
수금률: 16.7% ✅
```

### 검증 2: 전액 수금
```
입력: 단가 $300, 호수 550~555 (6개)
계산: $300 × 6 = $1,800
결과: 총액 $1,800 ✅

수금: $1,800
미수금: $1,800 - $1,800 = $0 ✅
수금률: 100% ✅ (초록색)
```

### 검증 3: 단발 광고
```
입력: 단가 $200, 호수 없음
계산: 총액 = $200
결과: 총액 $200 ✅

수금: $0
미수금: $200 - $0 = $200 ✅
수금률: 0% ✅ (빨간색)
```

---

## 📝 요약

### 핵심 공식
```
✅ 총 계약 금액 = 단가 × 호수 (호수 없으면 단가가 총액)
✅ 미수금 = 총 계약 금액 - 수금 완료
✅ 수금률 = (수금 완료 / 총 계약 금액) × 100%
```

### 변경 사항
```
이전: 원본 시트의 "Have collect" 값 사용
현재: 앱에서 자동 계산 (더 정확)
```

### 새 고객 추가 시
```
초기 수금 = $0
초기 미수금 = 총 계약 금액
```

---

**💡 이제 미수금이 정확하게 계산됩니다!**
